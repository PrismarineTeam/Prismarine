From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: AlphaKR93 <alphakr93@outlook.com>
Date: Sun, 2 Oct 2022 21:26:45 +0900
Subject: [PATCH] Force despawn API


diff --git a/src/main/java/net/minecraft/world/entity/Entity.java b/src/main/java/net/minecraft/world/entity/Entity.java
index ccb5ad57f173ba27ab1d4a87e6323565248a2bf4..1dc720ca3844ef3a9bad7e470f67fb231859683a 100644
--- a/src/main/java/net/minecraft/world/entity/Entity.java
+++ b/src/main/java/net/minecraft/world/entity/Entity.java
@@ -4432,6 +4432,8 @@ public abstract class Entity implements Nameable, EntityAccess, CommandSource {
 
     public void checkDespawn() {}
 
+    public void setForceDespawn(boolean force) {} // Prismarine
+
     public Vec3 getRopeHoldPosition(float delta) {
         return this.getPosition(delta).add(0.0D, (double) this.eyeHeight * 0.7D, 0.0D);
     }
diff --git a/src/main/java/net/minecraft/world/entity/Mob.java b/src/main/java/net/minecraft/world/entity/Mob.java
index d5e3bd662da349fc2ee58c7800d79c60300f33b3..4fe0cf5364dcedbff3a9287e565b1bedcd8031a4 100644
--- a/src/main/java/net/minecraft/world/entity/Mob.java
+++ b/src/main/java/net/minecraft/world/entity/Mob.java
@@ -136,6 +136,7 @@ public abstract class Mob extends LivingEntity {
 
     public int ticksSinceLastInteraction; // Purpur
     public boolean aware = true; // CraftBukkit
+     public boolean forceDespawn = false; // Prismarine
 
     protected Mob(EntityType<? extends Mob> type, Level world) {
         super(type, world);
@@ -838,7 +839,7 @@ public abstract class Mob extends LivingEntity {
     public void checkDespawn() {
         if (this.level.getDifficulty() == Difficulty.PEACEFUL && this.shouldDespawnInPeaceful()) {
             this.discard();
-        } else if (!this.isPersistenceRequired() && !this.requiresCustomPersistence()) {
+        } else if (!this.isPersistenceRequired() && !this.requiresCustomPersistence() || this.forceDespawn) { // Prismarine
             // Paper start - optimise checkDespawn
             Player entityhuman = this.level.findNearbyPlayer(this, level.paperConfig().entities.spawning.despawnRanges.get(this.getType().getCategory()).hard() + 1, EntitySelector.affectsSpawning); // Paper
             if (entityhuman == null) {
@@ -870,6 +871,13 @@ public abstract class Mob extends LivingEntity {
         }
     }
 
+    // Prismarine start
+    @Override
+    public void setForceDespawn(boolean force) {
+        this.forceDespawn = force;
+    }
+    // Prismarine end
+
     @Override
     protected final void serverAiStep() {
         ++this.noActionTime;
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
index 10208b3be330e8a02a4b248a3861ba978e64aab4..fa5e01d06a16bd1e4f6408eaff448104d331a89d 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
@@ -687,6 +687,13 @@ public abstract class CraftEntity implements org.bukkit.entity.Entity {
         this.entity.discard();
     }
 
+    // Prismairne start
+    @Override
+    public void setRemove(boolean force) {
+        this.entity.setForceDespawn(force);
+    }
+    // Prismarine end
+
     @Override
     public boolean isDead() {
         return !this.entity.isAlive();
